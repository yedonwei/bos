<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>区域设置</title>

    <!-- 导入jquery核心类库 -->
    <script type="text/javascript" src="../../js/jquery-1.8.3.js"></script>

    <!-- 导入ocupload -->
    <script type="text/javascript" src="../../js/ocupload/jquery.ocupload-1.1.2.js"></script>

    <!-- 导入easyui类库 -->
    <link rel="stylesheet" type="text/css" href="../../js/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../js/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../js/easyui/ext/portal.css">
    <link rel="stylesheet" type="text/css" href="../../css/default.css">
    <script type="text/javascript" src="../../js/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../js/easyui/ext/jquery.portal.js"></script>
    <script type="text/javascript" src="../../js/easyui/ext/jquery.cookie.js"></script>
    <script src="../../js/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <link href="../../js/citypicker/city-picker.css" rel="stylesheet" type="text/css"/>
    <script src="../../js/citypicker/city-picker.data.js"></script>
    <script src="../../js/citypicker/city-picker.js"></script>
    <script type="text/javascript">
        $(function () {
            // 先将body隐藏，再显示，不会出现页面刷新效果
            $("body").css({visibility: "visible"});
            // 区域管理数据表格
            $('#grid').datagrid({
                iconCls: 'icon-forward',
                fit: true,
                border: false,
                rownumbers: true,
                striped: true,
                pageList: [15,30, 50, 100],
                pagination: true,
                toolbar: toolbar,
                url: "../../area_pageQuery.action",
                idField: 'id',
                columns: columns,
                singleSelect:true
            });

            // 添加、修改区域窗口
            $('#addWindow').window({
                title: '添加修改区域',
                width: 800,
                modal: true,
                shadow: true,
                closed: true,
                height: 300,
                resizable: false
            });
            // 为快递员的保存按钮，设置点击事件
            $('#save').click(function(){
                // 判断form元素 是否满足 校验规则
                if( $("#areaForm").form('validate') ) {
                    $("#areaForm").submit();
                } else {
                    $.messager.alert("警告","表单中存在非法输入项！","warning");
                }
            });
        });
        // 将form请求数据转换为json对象
        $.fn.serializeJson = function () {
            var serializeObj = {};
            var array = this.serializeArray();
            var str = this.serialize();
            $(array).each(function () {
                if (serializeObj[this.name]) {
                    if ($.isArray(serializeObj[this.name])) {
                        serializeObj[this.name].push(this.value);
                    } else {
                        serializeObj[this.name] = [serializeObj[this.name], this.value];
                    }
                } else {
                    serializeObj[this.name] = this.value;
                }
            });
            return serializeObj;
        };

        // 定义列
        var columns = [ [{
            field: 'id',
            checkbox: true,
        }, {
            field: 'province',
            title: '省',
            width: 120,
            align: 'center'
        }, {
            field: 'city',
            title: '市',
            width: 120,
            align: 'center'
        }, {
            field: 'district',
            title: '区',
            width: 120,
            align: 'center'
        }, {
            field: 'postalCode',
            title: '邮编',
            width: 120,
            align: 'center'
        }, {
            field: 'pcd',
            title: '简码',
            width: 120,
            align: 'center'
        }, {
            field: 'pinyinCity',
            title: '城市编码',
            width: 200,
            align: 'center'
        }]];

        //工具栏
        var toolbar = [ {
            id: 'button-add',
            text: '增加',
            iconCls: 'icon-add',
            handler: doAdd
        },{
            id: 'button-edit',
            text: '修改',
            iconCls: 'icon-edit',
            handler: doView
        }, {
            id: 'button-import',
            text: '导入',
            iconCls: 'icon-redo'
        }, {
            id: 'button-search',
            text: '查询',
            iconCls: 'icon-search',
            handler: function () {
                $("#searchWindow").window('open');
            }
        }];

        //保存
        function doAdd(){
            // 显示下拉列表
            $("#city-picker").citypicker();
            // 清除表单回显操作
            $("#areaForm").form("clear");
            //重置
            $("#city-picker").citypicker();
            $("#reset").click(function () {
                $("#city-picker").citypicker('reset');
            })
            //打开窗口
            $('#addWindow').window("open");
        }

        //修改
        function doView(){
            // 获取当前datagrid选中数据
            var rows = $("#grid").datagrid('getSelections');
            if(rows.length != 1) {
                // 没选 或 多选
                $.messager.alert("提示信息","修改数据时，只能选中一行","warning");
            }else {
                // 只选中一行
                var row = rows[0];
                // 进行表单回显操作
                $("#city-picker").citypicker('reset');
                $("#city-picker").citypicker('destroy');
                $("#city-picker").citypicker({
                    province:row.province,
                    city: row.city,
                    district:row.district
                });
                //重置
                $("#city-picker").citypicker();
                $("#reset").click(function () {
                    $("#city-picker").citypicker('reset');
                    $("#areaForm").form("clear");
                })
                $("#areaForm").form('load', row);
                // 显示窗口
                $("#addWindow").window('open');
            }
        }


        //导入按钮,添加事件
        $(function () {
            $("#button-import").upload({
                action : "../../area_upload.action",
                onSelect : function () {
                    //关闭自动提交
                    this.autoSubmit=false;
                    //判断文件格式是否正确
                    var fieldName = this.filename();
                    var regex=/^.*\.(xls|xlsx)$/;
                    if(regex.test(fieldName)){
                        //如果正确提交文件
                        this.submit();
                    }else{
                       $.messager.alert("你提交的文件格式不正确,请重新提交");
                    }
                },
                onComplete : function (reponse) {
                   if(reponse == "0"){
                       alert("文件上传成功");
                       location.onload();
                   }else{
                       alert("文件上传失败");
                   }
                }
            });
        });
    </script>
</head>

<body class="easyui-layout" style="visibility:hidden;">
<div region="center" border="false">
    <table id="grid"></table>
</div>
<div class="easyui-window" title="区域添加修改" id="addWindow" collapsible="false" minimizable="false" maximizable="false"
     style="top:10px;left:200px">
    <div region="north" style="height:31px;overflow:hidden;" split="false" border="false">
        <div class="datagrid-toolbar">
            <a id="save" icon="icon-save" href="#" class="easyui-linkbutton" plain="true">保存</a>
        </div>
    </div>
    <div region="center" style="overflow:auto;padding:5px;" border="false">
        <form id="areaForm" action="../../area_save.action" method="post">
            <table class="table-edit" width="80%" align="center">
                <tr>
                    <td>省市区</td>
                    <td>
                        <div style="position: relative;">
                            <input type="hidden" name="id" />
                            <input name="areaInfo" id="city-picker" readonly type="text">
                            <input id="reset" type="button" value="重置"/>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>邮编</td>
                    <td>
                        <input type="text" name="postalCode" class="easyui-validatebox" required="true"/>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<!-- 查询区域-->
<div class="easyui-window" title="查询区域窗口" closed="true" id="searchWindow" collapsible="false" minimizable="false"
     maximizable="false" style="width: 400px; top:40px;left:200px">
    <div style="overflow:auto;padding:5px;" border="false">
        <form id="searchForm">
            <table class="table-edit" width="80%" align="center">
                <tr>
                    <td>省份</td>
                    <td>
                        <input type="text" name="province"/>
                    </td>
                </tr>
                <tr>
                    <td>城市</td>
                    <td>
                        <input type="text" name="city"/>
                    </td>
                </tr>
                <tr>
                    <td>区（县）</td>
                    <td>
                        <input type="text" name="district"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><a id="searchBtn" href="#" class="easyui-linkbutton"
                                       data-options="iconCls:'icon-search'">查询</a></td>
                </tr>
            </table>
        </form>
    </div>
</div>
</body>

</html>